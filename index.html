<!DOCTYPE html>
<html>
<head>
    <title>netsh helper</title>

    <style>
        table {
            margin-top: 50px;
            border-collapse: collapse;
            width: 100%;
            text-align: center;
        }

        table tr:nth-child(even) {
            background: lightgray;
        }

        .actions {
            margin-bottom: 20px;
        }

        label {
            display: block;
        }
    </style>
</head>
<body>

<div class="actions">
    <input type="button" value="ntsh list refresh" id="netshListButton"/>
</div>

<div class="add">
    <label>Domain</label>
    <input type="text" id="input-host-domain"/>

    <label>ListenAddress</label>
    <input type="text" id="input-listen-address"/>

    <label>ListenPort</label>
    <input type="number" id="input-listen-port"/>

    <label>ConnectAddress</label>
    <input type="text" id="input-connect-address"/>

    <label>ConnectPort</label>
    <input type="number" id="input-connect-port"/>

    <input type="button" value="add" id="add-button"/>
</div>

<br><br><br>
<label>Delete</label>
<input type="number" id="delete-id"/>
<input type="button" id="delete-button" value="Delete" />

<table id="table-netsh">

</table>

<script src="/socket.io/socket.io.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        var netshList = [];

        const socket = io('http://localhost:81');

        /** received events */
        socket.on('netsh list', (data) => {
            netshList = [];

            const lastIndex = data.lastIndexOf('-');
            data = data.substr(lastIndex + 1).replace(/\r?\n|\r/g, ' ').replace(/  +/g, ' ').trim().split(' ');

            for (var i = 0; i < data.length; i++) {
                var id = i;
                var listenAddress = data[i];
                var listenPort = data[++i];
                var connectAddress = data[++i];
                var connectPort = data[++i];

                netshList.push({
                    id,
                    listenAddress,
                    listenPort,
                    connectAddress,
                    connectPort
                })
            }
        });

        socket.on('host file', data => {
            hosts = [];

            data = data.replace(/\t/g, ' ').replace(/ +/g, ' ').replace(/\r?\n|\r/g, ' ').split(' ');

            for(let i = 0; i < data.length; i++) {
                const ip = data[i];
                const domain = data[++i];

                hosts.push(
                    {ip,domain}
                )
            }


            hosts.map(h => {
                const net = netshList.find(n => n.listenAddress === h.ip );
                net.domain = h.domain;
            });

            generateTable(
                document.getElementById('table-netsh'),
                netshList
            );
        });


        /** buttons */
        const netshListButton = document.getElementById('netshListButton');
        const netshAddButton = document.getElementById('add-button');
        const netshDeleteButton = document.getElementById('delete-button');

        /** sending events **/
        netshListButton.addEventListener('click', (e) => {
            socket.emit('netsh get list');
        });

        netshAddButton.addEventListener('click', function() {
            var domain = document.getElementById('input-host-domain').value;
            var listenAddress = document.getElementById('input-listen-address').value;
            var listenPort = document.getElementById('input-listen-port').value;
            var connectAddress = document.getElementById('input-connect-address').value;
            var connectPort = document.getElementById('input-connect-port').value;

            socket.emit('netsh add', {
                domain,
                listenAddress,
                listenPort,
                connectAddress,
                connectPort
            })
        });

        netshDeleteButton.addEventListener('click', function() {
            const id = document.getElementById('delete-id').value;

            const el = netshList.find(e => e.id === +id);
            socket.emit('netsh delete', el);
        });

        function generateTable(table, data) {
            table.innerHTML = "";

            const headerTr = document.createElement('tr');
            for(let k in data[0]) {
                const th = document.createElement('th');
                th.innerText = k;
                headerTr.appendChild(th);
            }
            table.appendChild(headerTr);

            for(var i = 0;i < data.length; i++) {
                const tr = document.createElement('tr');

                for(let k in data[i]) {
                    const td = document.createElement('td');
                    td.innerText = data[i][k];
                    tr.appendChild(td);
                }

                table.appendChild(tr);
            }

        }


    });


</script>
</body>
</html>